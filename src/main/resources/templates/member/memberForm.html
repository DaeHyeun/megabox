<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{/layout/basic::setContent(~{this::content})}">
    <th:block th:fragment="content">
        <h2>회원 가입 페이지</h2>
        <form action="/member/join" method="post" onsubmit="return valid()">
            <div class="form-group">
                이메일
                <input type="email" required class="form-control" name="email" id="inputEmail" placeholder="이메일을 입력해주세요"/>
                <br/>
                <button type="button" onclick="emailCheck()" class="btn btn-primary">아이디 중복 체크</button>
            </div>
            <div class="form-group">
                비밀번호
                <input type="password" class="form-control" name="password" id="password1" placeholder="비밀번호를 입력해주세요"/>
            </div>
            <!--비밀번호 유효성 체크해서 문구 띄우는 div-->
            <div id="resultDiv1"></div>
            <div class="form-group">
                비밀번호 확인
                <input type="password" class="form-control" name="checkPassword" id="password2" placeholder="비밀번호를 한번 더 입력해주세요" disabled/>
            </div>
            <div id="resultDiv2"></div>
            <div class="form-group">
                이름
                <input type="text" required class="form-control" name="name" placeholder="이름을 입력해주세요"/>
            </div>

            <div class="form-group">
                주소
                <input type="text" class="form-control"  id="zipcode" name="zipcode" placeholder="우편번호 찾기 버튼을 클릭해주세요." readonly>
                <input type="button" class="btn btn-primary" value="우편번호 찾기" id="zipbtn" style="margin-left: 320px;">
                <input type="text" class="form-control" id="addr" name="addr" placeholder="주소" readonly>
                <input type="text"  class="form-control" id="addr_detail" name="addr_detail" placeholder="상세주소">
            </div>

            <div class="form-group">
                전화번호
                <input type="text" required class="form-control" name="pnumber" placeholder="전화번호를 입력해주세요"/>
            </div>
            <button type="submit" class="btn btn-primary">가입하기</button>
        </form>
        <script>
            //우편번호 검색 다음 우편번호 API
            let zipbtn = document.querySelector("#zipbtn");
            zipbtn.addEventListener("click",()=>{
                new daum.Postcode({
                    oncomplete: function(data) {
                        console.log(data);
                        let fullAddr = "";
                        let extraAddr = "";

                        if (data.userSelectedType=='R'){
                            fullAddr =  data.roadAddress;
                        }else{
                            fullAddr = data.jibunAddress;
                        }

                        //extraAddr에 값 대입하기
                            if(data.bname !==''){
                            extraAddr += data.bname;
                        }
                        if(data.buildingName !==''){
                            extraAddr += (extraAddr !=='' ? ', '+data.buildingName : data.buildingName)
                        }

                        fullAddr += (extraAddr !=='' ? ' ('+extraAddr+')' : '');

                        document.querySelector("#addr").value = fullAddr;
                        document.querySelector("#zipcode").value= data.zonecode;
                        document.querySelector("#addr_detail").focus();
                    }
                }).open();
            });


            //아이디 중복체크 확인하는 변수
            let isIdChecking = false;
            //비밀번호 유효성 확인하는 변수
            let isPassChecking = false;
            //비밀번호1이랑 2랑 같은지 확인하는 변수
            let passEqualChecking = false;

            //회원가입 form submit 버튼 클릭하면 호출되는 함수
            function valid(){
                if(!isIdChecking || !isPassChecking || !passEqualChecking){
                    alert("아이디 또는 비밀번호를 확인해주세요!")
                    return false;
                }else{
                    return true;
                }
            }

            //아이디 중복체크 버튼 클릭할 때 호출되는 함수
            function emailCheck(){
                console.log("클릭!!");
                let email = $("#inputEmail").val();
                if (email==""){
                    alert("이메일을 입력해주세요!")
                }
                else{
                    //입력한 이메일 값 자바스크립트 객체에 담기
                    let data = {
                        email : email
                    }
                    //ajax 를 통해 전달
                    $.ajax({
                        url : "/findMember/emailCheck",
                        type : "post",
                        data : JSON.stringify(data),
                        contentType : "application/json; charset=utf-8",
                        dataType : "text",
                        success : function(result){
                            if(result=="ok"){
                                alert("이미 사용중인 이메일입니다.");
                                isIdChecking = false;
                            }else{
                                alert("사용 가능한 이메일입니다.");
                                isIdChecking = true;
                            }
                        }
                    })
                }
            }

            //실시간으로 비밀번호 유효성 확인하기
            let password = $("#password1");
            let checkPassword = $("#password2");
            let resultDiv1 = $("#resultDiv1");
            let resultDiv2 = $("#resultDiv2");

            //비밀번호1 유효성 확인 함수
            password.keyup(function(){
                let passValue = password.val();
                if(passValue !==''){
                    if(!isValidPassword(passValue)){
                        resultDiv1.html("비밀번호는 8자 이상의 영문자로 작성해주세요.").css("color", "red");
                        isPassChecking = false;
                    }else{
                        resultDiv1.html("유효한 비밀번호입니다.").css("color", "green");
                        isPassChecking = true;
                    }
                }

                //비밀번호1 유효성 확인이 통과되면 disable 속성 빼기
                if (isPassChecking) {
                    checkPassword.prop('disabled', false);
                } else {
                    checkPassword.prop('disabled', true);
                }
            })

            //비밀번호 유효성 정규식 함수
            function isValidPassword(password){
                let regex = /^(?=.*[a-zA-Z]).{8,16}$/;
                return regex.test(password);
            }



            //비밀번호2와 비밀번호1이 같은지 체크하는 함수
            checkPassword.keyup(function(){
                let passValue = password.val();
                let passCheckValue = checkPassword.val();
                if (passValue !=='' && passCheckValue !==''){
                    if(passValue !== passCheckValue){
                        resultDiv2.html("비밀번호가 일치하지 않습니다.").css("color", "red");
                        passEqualChecking = false;
                    } else {
                        resultDiv2.html("비밀번호가 일치합니다.").css("color", "green");
                        passEqualChecking = true;
                    }
                }
            })


        </script>
    </th:block>
</th:block>
</html>